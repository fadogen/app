---
services:
  backup:
    image: offen/docker-volume-backup:v2
    environment:
      # S3 / S3-compatible storage
      AWS_S3_BUCKET_NAME: "${BACKUP_S3_BUCKET:-}"
      AWS_S3_PATH: "${BACKUP_S3_PATH:-}"
      AWS_ACCESS_KEY_ID: "${BACKUP_AWS_ACCESS_KEY_ID:-}"
      AWS_SECRET_ACCESS_KEY: "${BACKUP_AWS_SECRET_ACCESS_KEY:-}"
      AWS_ENDPOINT: "${BACKUP_AWS_ENDPOINT:-}"
      AWS_DEFAULT_REGION: "${BACKUP_AWS_DEFAULT_REGION:-}"
      # Dropbox
      DROPBOX_REMOTE_PATH: "${BACKUP_DROPBOX_REMOTE_PATH:-}"
      DROPBOX_APP_KEY: "${BACKUP_DROPBOX_APP_KEY:-}"
      DROPBOX_APP_SECRET: "${BACKUP_DROPBOX_APP_SECRET:-}"
      DROPBOX_REFRESH_TOKEN: "${BACKUP_DROPBOX_REFRESH_TOKEN:-}"
      # Common
      BACKUP_CRON_EXPRESSION: "0 3 * * *"
      BACKUP_RETENTION_DAYS: "${BACKUP_RETENTION_DAYS:-7}"
      EXEC_LABEL: "{{PROJECT_NAME}}"
    volumes:
      - backup_dumps:/backup/dumps:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal
    logging:
      driver: 'json-file'
      options:
        max-size: "50m"
        max-file: "6"
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role==manager
      resources:
        limits:
          memory: 256M
