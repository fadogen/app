---
# Fadogen VPS Provisioning Playbook
# Security hardening and service installation

- name: Provision VPS Server
  hosts: all
  become: true
  gather_facts: true

  vars:
    # geerlingguy.pip configuration
    pip_install_packages:
      - name: docker
      - name: jsondiff

    # geerlingguy.security configuration
    security_ssh_port: 22
    security_ssh_password_authentication: "no"
    security_ssh_permit_root_login: "no"
    security_fail2ban_enabled: true
    security_autoupdate_enabled: true
    security_sudoers_passwordless:
      - "{{ fadogen_target_user }}"

    # geerlingguy.firewall configuration
    firewall_allowed_tcp_ports: "{{ ['22'] if (has_cloudflare_tunnel | default(false) | bool) else ['22', '80', '443'] }}"
    firewall_disable_ufw: true # Use iptables directly

    # geerlingguy.docker configuration
    docker_users:
      - "{{ fadogen_target_user }}"

  pre_tasks:
    - name: Wait for SSH connection to be ready
      wait_for_connection:
        connect_timeout: 10
        sleep: 5
        timeout: 300

    - name: Detect current remote user
      command: whoami
      register: current_remote_user
      changed_when: false
      become: false

    - name: Verify we're connected as target user or have sudo access
      fail:
        msg: "Must run as {{ fadogen_target_user }} or provide sudo password. Current user: {{ current_remote_user.stdout }}"
      when:
        - current_remote_user.stdout != fadogen_target_user
        - ansible_become_password is not defined or ansible_become_password | length == 0

    - name: Ensure iptables is installed (required for firewall configuration)
      ansible.builtin.apt:
        name: iptables
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Set iptables default policies to ACCEPT before firewall configuration
      ansible.builtin.iptables:
        chain: "{{ item }}"
        policy: ACCEPT
      loop:
        - INPUT
        - FORWARD
        - OUTPUT
      ignore_errors: true

    - name: Flush existing iptables rules safely
      ansible.builtin.shell: |
        iptables -F 2>/dev/null || true
        iptables -X 2>/dev/null || true
        iptables -t nat -F 2>/dev/null || true
        iptables -t mangle -F 2>/dev/null || true
      changed_when: false
      ignore_errors: true

  roles:
    - role: geerlingguy.pip
    - role: geerlingguy.security
    - role: geerlingguy.ntp
    - role: geerlingguy.firewall
    - role: geerlingguy.docker

    - name: Install and configure Traefik
      role: traefik
