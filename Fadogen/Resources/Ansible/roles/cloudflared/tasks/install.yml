---
# Ansible Role: cloudflared
# Installation tasks - package manager approach

# Debian/Ubuntu installation

# Cleanup old configurations (migration from deprecated apt_key)
- name: Remove old apt-key configuration if present
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/cloudflare.asc
    state: absent
  when: ansible_os_family == "Debian"

- name: Remove old apt source list if present
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/cloudflared.list
    state: absent
  when: ansible_os_family == "Debian"

- name: Add Cloudflare repository with automatic GPG key management
  ansible.builtin.deb822_repository:
    name: cloudflared
    types: deb
    uris: https://pkg.cloudflare.com/cloudflared
    suites: any
    components: main
    signed_by: https://pkg.cloudflare.com/cloudflare-main.gpg
    state: present
  when: ansible_os_family == "Debian"
  register: cloudflare_repo

- name: Install cloudflared package (Debian/Ubuntu)
  ansible.builtin.apt:
    name: cloudflared
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"
  register: cloudflared_package

- name: Verify cloudflared is installed
  ansible.builtin.command: cloudflared --version
  register: cloudflared_version
  changed_when: false
  failed_when: cloudflared_version.rc != 0